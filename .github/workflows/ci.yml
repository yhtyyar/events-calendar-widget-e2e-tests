name: E2E Tests with Visual Artifacts

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ð¢Ð¸Ð¿ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - functional
          - visual

env:
  NODE_VERSION: '20'
  ARTIFACTS_RETENTION_DAYS: 7

jobs:
  # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ E2E Ñ‚ÐµÑÑ‚Ñ‹
  test:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run tests
        run: npx playwright test --project=${{ matrix.browser }}
        continue-on-error: true

      - name: Check artifacts size
        id: size-check
        if: always()
        run: |
          if [ -d "test-artifacts" ]; then
            ARTIFACT_SIZE=$(du -sm test-artifacts | cut -f1)
            echo "Total artifacts size: ${ARTIFACT_SIZE} MB"
            echo "artifact_size=${ARTIFACT_SIZE}" >> $GITHUB_OUTPUT
            if [ $ARTIFACT_SIZE -gt 300 ]; then
              echo "âš ï¸ WARNING: Artifacts exceed 300MB threshold!" >&2
              echo "Consider reducing video retention or adding cleanup steps."
            fi
          else
            echo "No test-artifacts directory found"
            echo "artifact_size=0" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Cleanup large files before upload
        if: always()
        run: |
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ð²Ð¸Ð´ÐµÐ¾ Ñ„Ð°Ð¹Ð»Ñ‹ (>10MB) Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ð¼ÐµÑÑ‚Ð°
          find test-artifacts -name "*.webm" -size +10M -delete 2>/dev/null || true
          # Ð£Ð´Ð°Ð»ÑÐµÐ¼ trace.zip Ñ„Ð°Ð¹Ð»Ñ‹
          find test-artifacts -name "trace.zip" -delete 2>/dev/null || true
        shell: bash

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: html-report-${{ matrix.browser }}-${{ github.run_id }}
          path: test-artifacts/html-report/
          retention-days: ${{ env.ARTIFACTS_RETENTION_DAYS }}

      - name: Upload visual artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-artifacts-${{ matrix.browser }}-${{ github.run_id }}
          path: |
            test-artifacts/
            !test-artifacts/html-report/
          retention-days: ${{ env.ARTIFACTS_RETENTION_DAYS }}

      - name: Storage alert
        if: always() && steps.size-check.outputs.artifact_size > 500
        run: |
          echo "::error::Critical: Artifacts size exceeds GitHub limit (500 MB per artifact)"
          echo "Next steps:"
          echo "1. Reduce video retention in playwright.config.ts"
          echo "2. Add cleanup step for old artifacts"
          echo "3. Consider cloud storage migration"

  # Ð¢ÐµÑÑ‚Ñ‹ Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ…
  test-mobile:
    name: Mobile E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm install

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run mobile tests
        run: npx playwright test --project="Mobile Chrome" --project="Mobile Safari"
        continue-on-error: true

      - name: Check artifacts size
        id: size-check-mobile
        if: always()
        run: |
          if [ -d "test-artifacts" ]; then
            ARTIFACT_SIZE=$(du -sm test-artifacts | cut -f1)
            echo "Total artifacts size: ${ARTIFACT_SIZE} MB"
            echo "artifact_size=${ARTIFACT_SIZE}" >> $GITHUB_OUTPUT
          else
            echo "artifact_size=0" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Cleanup large files before upload
        if: always()
        run: |
          find test-artifacts -name "*.webm" -size +10M -delete 2>/dev/null || true
          find test-artifacts -name "trace.zip" -delete 2>/dev/null || true
        shell: bash

      - name: Upload mobile artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: visual-artifacts-mobile-${{ github.run_id }}
          path: test-artifacts/
          retention-days: ${{ env.ARTIFACTS_RETENTION_DAYS }}

  # Ð¡Ð²Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [test, test-mobile]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ–¥ï¸ Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€Ñ‹:" >> $GITHUB_STEP_SUMMARY
          echo "- Chromium" >> $GITHUB_STEP_SUMMARY
          echo "- Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- WebKit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°:" >> $GITHUB_STEP_SUMMARY
          echo "- iPhone 12 (Safari)" >> $GITHUB_STEP_SUMMARY
          echo "- Pixel 5 (Chrome)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ ÐÑ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹:" >> $GITHUB_STEP_SUMMARY
          echo "- **HTML-Ð¾Ñ‚Ñ‡Ñ‘Ñ‚Ñ‹**: html-report-*" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¡ÐºÑ€Ð¸Ð½ÑˆÐ¾Ñ‚Ñ‹**: visual-artifacts-*" >> $GITHUB_STEP_SUMMARY
          echo "- **Ð¡Ñ€Ð¾Ðº Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ**: ${{ env.ARTIFACTS_RETENTION_DAYS }} Ð´Ð½ÐµÐ¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ **Artifacts** Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ðµ workflow." >> $GITHUB_STEP_SUMMARY
