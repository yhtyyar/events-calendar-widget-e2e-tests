name: E2E Tests CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Ð¢Ð¸Ð¿ Ñ‚ÐµÑÑ‚Ð¾Ð² Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ°'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - functional
          - visual

env:
  NODE_VERSION: '20'
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

jobs:
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð° Ð¸ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Check formatting
        run: npm run format:check
        continue-on-error: true

  # ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ E2E Ñ‚ÐµÑÑ‚Ñ‹
  test:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Run smoke tests
        if: github.event.inputs.test_type == 'smoke' || github.event.inputs.test_type == ''
        run: npm run test:smoke -- --project=${{ matrix.browser }}
        continue-on-error: true

      - name: Run all tests
        if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == ''
        run: npm test -- --project=${{ matrix.browser }}
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.browser }}
          path: |
            reports/
            test-results/
          retention-days: 30

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}
          path: reports/html/
          retention-days: 30

  # Ð¢ÐµÑÑ‚Ñ‹ Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°Ñ…
  test-mobile:
    name: Mobile E2E Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium webkit

      - name: Run mobile tests
        run: npm run test:mobile
        continue-on-error: true

      - name: Upload mobile test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-mobile
          path: |
            reports/
            test-results/
          retention-days: 30

  # Ð¡Ð²Ð¾Ð´Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚
  report:
    name: Generate Summary Report
    runs-on: ubuntu-latest
    needs: [test, test-mobile]
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-reports/

      - name: Generate summary
        run: |
          echo "## ðŸ“Š Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ð‘Ñ€Ð°ÑƒÐ·ÐµÑ€Ñ‹:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Chromium" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… WebKit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± iPhone 12 (Safari)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“± Pixel 5 (Chrome)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ñ‹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ð² Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð°Ñ… ÑÐ±Ð¾Ñ€ÐºÐ¸." >> $GITHUB_STEP_SUMMARY
