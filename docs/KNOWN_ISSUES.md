# Известные проблемы и ограничения

## Обзор

Данный документ содержит описание известных проблем, ограничений и особенностей при работе с тестовым фреймворком.

---

## 1. Проблемы браузеров

### 1.1 Firefox: Clipboard API

**Проблема**: Firefox имеет строгие ограничения на доступ к буферу обмена через `navigator.clipboard`.

**Симптомы**:
- Ошибка `NotAllowedError: Clipboard write was blocked`
- Тест копирования в буфер не проходит

**Решение**:
- Реализована fallback-стратегия через `document.execCommand('copy')`
- Тест помечается аннотацией о особенности Firefox
- Альтернативная проверка через JavaScript API

**Статус**: Обход реализован в `helpers.ts`

---

### 1.2 WebKit: Permission API

**Проблема**: WebKit (Safari) может не поддерживать `context.grantPermissions()` для некоторых типов разрешений.

**Симптомы**:
- Ошибка при попытке выдать разрешения на clipboard

**Решение**:
- Обернуть в try-catch
- Использовать fallback-механизмы
- Добавить информативную аннотацию к тесту

**Статус**: Обработано в тестах

---

## 2. Проблемы страницы

### 2.1 Динамический контент

**Проблема**: Некоторые элементы на странице могут загружаться асинхронно.

**Симптомы**:
- Элемент не найден при быстром выполнении теста
- Flaky-тесты (нестабильные результаты)

**Решение**:
- Использование `waitForLoadState('networkidle')`
- Явные ожидания видимости элементов
- Retry-логика для нестабильных операций

**Статус**: Реализовано в `BasePage.navigate()`

---

### 2.2 Отсутствие data-testid

**Проблема**: На странице не используются атрибуты `data-testid` для тестирования.

**Симптомы**:
- Селекторы основаны на тексте и CSS-классах
- Риск поломки тестов при изменении дизайна

**Рекомендация**: 
- Запросить у разработчиков добавление `data-testid` атрибутов
- Использовать семантические селекторы как компромисс

**Статус**: Используются текстовые и CSS-селекторы с fallback

---

## 3. Ограничения тестов

### 3.1 Визуальное сравнение скриншотов

**Ограничение**: Тест `VIS-06` со сравнением скриншотов требует baseline-изображение.

**При первом запуске**:
- Тест создаст baseline-скриншот
- Последующие запуски будут сравнивать с ним

**Важно**:
- При изменениях дизайна нужно обновить baseline: `npx playwright test --update-snapshots`
- Допуск 10% различий для динамического контента

---

### 3.2 axe-core тест пропущен

**Ограничение**: Тест `A11Y-AXE` с полным аудитом accessibility помечен как `skip`.

**Причина**: Требуется дополнительная установка `@axe-core/playwright`.

**Активация**:
```bash
npm install -D @axe-core/playwright
```
Затем раскомментировать код в `a11y.spec.ts`.

---

## 4. CI/CD особенности

### 4.1 Время выполнения

**Наблюдение**: Полный прогон тестов занимает ~3-5 минут на CI.

**Факторы**:
- Установка браузеров (~1-2 минуты)
- Параллельное выполнение по браузерам
- Загрузка страницы по сети

**Оптимизации**:
- Кэширование npm-зависимостей
- Кэширование Playwright-браузеров
- Параллельные джобы матрицей

---

### 4.2 Артефакты

**Размер артефактов**: При сохранении видео и трейсов размер артефактов может достигать 100+ MB.

**Настройка**:
- Видео записывается только при retry
- Трейсы только при первом retry
- Retention: 30 дней

---

## 5. Известные flaky-тесты

### Нестабильные сценарии

| Тест | Причина | Митигация |
|------|---------|-----------|
| SMOKE-06 (Console errors) | Внешние скрипты могут давать CORS-ошибки | Фильтрация некритичных ошибок |
| FUNC-07 (Copy button) | Clipboard permissions | Аннотация и fallback |
| VIS-06 (Screenshot) | Динамический контент | Допуск 10% различий |

---

## 6. Рекомендации

### Для стабильности тестов

1. **Не использовать `waitForTimeout()`** без крайней необходимости
2. **Использовать явные ожидания** элементов
3. **Добавлять retry** для нестабильных операций
4. **Логировать** состояние при падениях

### При изменениях в UI

1. Обновить селекторы в `selectors.ts`
2. Обновить baseline-скриншоты если нужно
3. Прогнать тесты локально перед пушем

### При добавлении новых тестов

1. Использовать существующие Page Objects
2. Следовать соглашениям об именовании
3. Добавлять теги приоритета (`@P0`, `@P1`, `@P2`)

---

## 7. Контакты и поддержка

При обнаружении новых проблем:
1. Добавить описание в этот документ
2. Создать issue в репозитории
3. Приложить логи и скриншоты

---

*Последнее обновление: Январь 2025*
