# Тест-план: Виджет календаря мероприятий

## 1. Общая информация

| Параметр | Значение |
|----------|----------|
| **URL** | https://dev.3snet.info/eventswidget/ |
| **Тип приложения** | Веб-страница с генератором кода виджета |
| **Основная функция** | Генерация HTML-кода для встраивания календаря мероприятий |

### Цели тестирования
1. Проверка базовой работоспособности страницы
2. Валидация генерации и копирования кода виджета
3. Обеспечение кросс-браузерной совместимости
4. Контроль адаптивности на мобильных устройствах
5. Базовая проверка доступности (a11y)

### Критерии приёмки
- ✅ Все smoke-тесты (P0) проходят в 3 браузерах
- ✅ Функциональные тесты проходят на ≥95%
- ✅ Нет критических a11y-нарушений

---

## 2. Матрица покрытия

### По функционалу

| Функционал | Smoke | Functional | Visual | A11Y | Приоритет |
|------------|:-----:|:----------:|:------:|:----:|:---------:|
| Загрузка страницы | ✅ | — | — | — | P0 |
| Заголовок/описание | ✅ | ✅ | ✅ | ✅ | P0 |
| Генерация кода | — | ✅ | — | — | P0 |
| Копирование | — | ✅ | — | — | P0 |
| Адаптивность | — | — | ✅ | — | P1 |
| Доступность | — | — | — | ✅ | P2 |

### По браузерам и устройствам

| Проект | Браузер | Viewport | Приоритет |
|--------|---------|----------|:---------:|
| chromium | Chrome | 1920×1080 | P0 |
| firefox | Firefox | 1920×1080 | P0 |
| webkit | Safari | 1920×1080 | P0 |
| mobile-chrome | Chrome | Pixel 5 (393×851) | P1 |
| mobile-safari | Safari | iPhone 12 (390×844) | P1 |

---

## 3. Детальные тест-кейсы

### 3.1 Smoke-тесты (P0) — `@smoke`

#### SMOKE-01: Страница загружается с HTTP 200
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Сеть доступна, сервер работает |
| **Шаги** | 1. Отправить GET-запрос на `/eventswidget/` |
| **Ожидаемый результат** | HTTP статус 200, страница загружена |
| **Проверяемые элементы** | `response.status() === 200` |

#### SMOKE-02: Основной заголовок отображается
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Найти элемент с текстом «Нравится наш календарь мероприятий?» |
| **Ожидаемый результат** | Заголовок виден, текст содержит «календарь мероприятий» |
| **Проверяемые элементы** | `h1`, `.heading`, `[data-testid="main-heading"]` |

#### SMOKE-03: Описательный текст присутствует
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Найти элемент с текстом «Хочешь такой же?» |
| **Ожидаемый результат** | Описание видимо на странице |
| **Проверяемые элементы** | Текстовый блок под заголовком |

#### SMOKE-04: Title страницы корректный
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Получить `document.title` |
| **Ожидаемый результат** | Title содержит слово «календарь» |
| **Проверяемые элементы** | `<title>` |

#### SMOKE-05: Футер отображается
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Прокрутить до конца страницы<br>2. Проверить видимость футера |
| **Ожидаемый результат** | Footer элемент виден |
| **Проверяемые элементы** | `footer`, `.footer`, `[role="contentinfo"]` |

#### SMOKE-06: Нет критических ошибок в консоли
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Подписаться на события `console`<br>2. Загрузить страницу<br>3. Отфильтровать ошибки (исключая CORS, favicon) |
| **Ожидаемый результат** | Массив критических ошибок пуст |
| **Исключения** | Ошибки CORS, favicon, net::ERR |

#### SMOKE-07: Ссылка на календарь мероприятий
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Найти ссылку на `/events/` или «календарь мероприятий» |
| **Ожидаемый результат** | Ссылка присутствует и кликабельна |
| **Проверяемые элементы** | `a[href*="events"]` |

#### SMOKE-08: URL корректный после загрузки
| Поле | Значение |
|------|----------|
| **Файл** | `tests/smoke/basic-rendering.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Получить текущий URL |
| **Ожидаемый результат** | URL содержит «eventswidget» |
| **Проверяемые элементы** | `page.url()` |

---

### 3.2 Функциональные тесты (P0) — `@functional`

#### FUNC-01: Форма генерации виджета видима
| Поле | Значение |
|------|----------|
| **Файл** | `tests/functional/widget-generation.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Найти форму или контейнер генератора виджета |
| **Ожидаемый результат** | Форма видима и доступна для взаимодействия |
| **Проверяемые элементы** | `form`, `.widget-generator`, `[data-testid="generator"]` |

#### FUNC-02: Поле с кодом вставки доступно
| Поле | Значение |
|------|----------|
| **Файл** | `tests/functional/widget-generation.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Найти textarea/input с кодом для вставки |
| **Ожидаемый результат** | Поле видимо, содержит текст |
| **Проверяемые элементы** | `textarea`, `input[readonly]`, `code`, `.embed-code` |

#### FUNC-03: Код содержит валидный HTML
| Поле | Значение |
|------|----------|
| **Файл** | `tests/functional/widget-generation.spec.ts` |
| **Предусловия** | Поле с кодом найдено |
| **Шаги** | 1. Получить значение поля с кодом<br>2. Проверить на наличие HTML-тегов |
| **Ожидаемый результат** | Код содержит `<iframe` или `<script` или `<div` |
| **Валидация** | Regex: `/<(iframe|script|div)[^>]*>/i` |

#### FUNC-04: Кнопка копирования работает
| Поле | Значение |
|------|----------|
| **Файл** | `tests/functional/widget-generation.spec.ts` |
| **Предусловия** | Страница загружена |
| **Шаги** | 1. Найти кнопку «Копировать»<br>2. Кликнуть по кнопке<br>3. Проверить feedback (toast, изменение текста) |
| **Ожидаемый результат** | Кнопка кликабельна, есть визуальный feedback |
| **Проверяемые элементы** | `button:has-text("копир")`, `.copy-btn`, `[data-action="copy"]` |
| **Fallback (Firefox)** | Использовать `document.execCommand('copy')` |

#### FUNC-05: Clipboard API функционирует
| Поле | Значение |
|------|----------|
| **Файл** | `tests/functional/widget-generation.spec.ts` |
| **Предусловия** | Браузер поддерживает Clipboard API |
| **Шаги** | 1. Проверить доступность `navigator.clipboard`<br>2. Вызвать копирование<br>3. Прочитать буфер обмена |
| **Ожидаемый результат** | Буфер содержит код виджета |
| **Ограничения** | Firefox требует разрешения, используется fallback |

---

### 3.3 Визуальные/адаптивные тесты (P1) — `@visual`

#### VIS-01: Нет горизонтального скролла (mobile)
| Поле | Значение |
|------|----------|
| **Файл** | `tests/visual/responsive.spec.ts` |
| **Viewport** | 375×667 (iPhone SE), 390×844 (iPhone 12), 393×851 (Pixel 5) |
| **Шаги** | 1. Установить viewport<br>2. Загрузить страницу<br>3. Проверить `document.body.scrollWidth <= window.innerWidth` |
| **Ожидаемый результат** | Нет горизонтальной прокрутки |
| **Проверяемые элементы** | `body`, `.container`, основные блоки |

#### VIS-02: Ключевые элементы видны (tablet)
| Поле | Значение |
|------|----------|
| **Файл** | `tests/visual/responsive.spec.ts` |
| **Viewport** | 768×1024 (iPad), 1024×768 (iPad landscape) |
| **Шаги** | 1. Установить viewport<br>2. Проверить видимость заголовка, формы, футера |
| **Ожидаемый результат** | Все ключевые элементы в зоне видимости |

#### VIS-03: Desktop — все секции корректны
| Поле | Значение |
|------|----------|
| **Файл** | `tests/visual/responsive.spec.ts` |
| **Viewport** | 1920×1080, 1366×768 |
| **Шаги** | 1. Проверить layout секций<br>2. Убедиться в корректных отступах |
| **Ожидаемый результат** | Страница отображается без визуальных дефектов |

---

### 3.4 Тесты доступности (P2) — `@accessibility`

#### A11Y-01: Атрибут lang на html
| Поле | Значение |
|------|----------|
| **Файл** | `tests/accessibility/a11y.spec.ts` |
| **Шаги** | 1. Проверить `<html lang="...">` |
| **Ожидаемый результат** | Атрибут `lang` присутствует (например, `ru` или `en`) |
| **WCAG** | 3.1.1 Language of Page (Level A) |

#### A11Y-02: Alt-текст для изображений
| Поле | Значение |
|------|----------|
| **Файл** | `tests/accessibility/a11y.spec.ts` |
| **Шаги** | 1. Найти все `<img>`<br>2. Проверить наличие `alt` атрибута |
| **Ожидаемый результат** | Все изображения имеют alt (может быть пустым для декоративных) |
| **WCAG** | 1.1.1 Non-text Content (Level A) |

#### A11Y-03: Наличие h1
| Поле | Значение |
|------|----------|
| **Файл** | `tests/accessibility/a11y.spec.ts` |
| **Шаги** | 1. Найти элемент `<h1>` |
| **Ожидаемый результат** | Ровно один `<h1>` на странице |
| **WCAG** | 1.3.1 Info and Relationships (Level A) |

#### A11Y-04: Клавиатурная навигация
| Поле | Значение |
|------|----------|
| **Файл** | `tests/accessibility/a11y.spec.ts` |
| **Шаги** | 1. Нажать Tab несколько раз<br>2. Проверить фокус на интерактивных элементах<br>3. Убедиться в видимом индикаторе фокуса |
| **Ожидаемый результат** | Все интерактивные элементы доступны с клавиатуры |
| **WCAG** | 2.1.1 Keyboard (Level A) |

---

## 4. Логирование и отчётность

### Allure Reporter
Проект использует **Allure Reporter** для детального логирования:

```bash
# Запуск тестов с генерацией Allure-отчёта
npm test

# Открыть Allure-отчёт
npm run report:allure
```

### Что логируется
- **Шаги теста** — каждый шаг с временем выполнения
- **Скриншоты** — при падении теста
- **Видео** — при retry (только в CI)
- **Trace** — детальная трассировка при первом retry
- **Console logs** — ошибки браузерной консоли

### Артефакты CI
| Артефакт | Описание | Retention |
|----------|----------|-----------|
| `playwright-report-*` | HTML-отчёт Playwright | 7 дней |
| `allure-results-*` | Данные для Allure | 7 дней |

---

## 5. Известные ограничения

| Проблема | Влияние | Решение |
|----------|---------|---------|
| Firefox: Clipboard API ограничен | Средний | Fallback через `document.execCommand('copy')` |
| Mobile Safari: нет записи видео | Низкий | Только скриншоты при ошибках |
| Динамический контент | Средний | Явные ожидания (`waitForSelector`, `waitForLoadState`) |
| CORS для внешних ресурсов | Низкий | Игнорируем в console error check |

---

## 6. Команды запуска

```bash
# Все тесты
npm test

# По категориям
npm run test:smoke          # Smoke-тесты (быстро)
npm run test:functional     # Функциональные тесты
npm run test:visual         # Адаптивные тесты
npm run test:a11y           # Тесты доступности

# По браузерам
npm run test:chromium       # Chrome
npm run test:firefox        # Firefox
npm run test:webkit         # Safari

# Мобильные
npm run test:mobile         # Pixel 5 + iPhone 12

# Отладка
npm run test:headed         # С UI браузера
npm run test:debug          # Debug mode
npm run test:ui             # Интерактивный UI Playwright

# Отчёты
npm run report              # Playwright HTML-отчёт
npm run report:allure       # Allure отчёт (детальный)
```

---

*Версия 3.0 | Январь 2025*
